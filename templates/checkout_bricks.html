    <!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{{ page_title }}</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
        <!-- SDK de Mercado Pago -->
        <script src="https://sdk.mercadopago.com/js/v2"></script>
        <style>
            /* Estilos básicos para centrar el Brick y hacerlo responsivo */
            body {
                font-family: Arial, sans-serif;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                background-color: #f0f2f5;
                margin: 0;
                padding: 20px;
                box-sizing: border-box;
            }
            .container {
                background-color: #ffffff;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                max-width: 600px;
                width: 100%;
                text-align: center;
            }
            h1 {
                color: #333;
                margin-bottom: 25px;
                font-size: 1.8em;
            }
            /* Estilos para el contenedor del Brick */
            #paymentBrick_container {
                min-height: 300px; /* Asegura un espacio mínimo para que el Brick se muestre */
                margin-top: 20px;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .loading-message {
                color: #555;
                font-size: 1.1em;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Confirmar tu pago</h1>
            <p>Estás a un paso de completar tu inscripción.</p>
            <div id="paymentBrick_container">
                <p class="loading-message">Cargando opciones de pago...</p>
            </div>
        </div>

        <script>
            const preferenceId = "{{ preference_id }}";
            const publicKey = "{{ public_key }}"; // Esta será tu Public Key de producción
            const claseBarco = "{{ clase_barco }}";
            const transactionAmount = parseFloat("{{ transaction_amount }}");

            console.log("------------------------------------------");
            console.log("Iniciando Payment Brick con los siguientes datos:");
            console.log("Preference ID:", preferenceId);
            console.log("Public Key:", publicKey);
            console.log("Transaction Amount:", transactionAmount);
            console.log("------------------------------------------");


            const mp = new MercadoPago(publicKey, {
                locale: 'es-AR'
            });

            const bricksBuilder = mp.bricks();

            bricksBuilder.create("payment", "paymentBrick_container", {
                initialization: {
                    preferenceId: preferenceId,
                    amount: transactionAmount,
                },
                customization: {
                    paymentMethods: {
                        // La exclusión de "ticket" se maneja directamente en la preferencia del backend.
                    },
                    visual: {
                        theme: 'default',
                        hideFormTitle: true,
                    }
                },
                callbacks: {
                    onReady: () => {
                        console.log('Payment Brick está listo');
                        document.querySelector('.loading-message').style.display = 'none';
                    },
                    onSubmit: ({ selectedPaymentMethod, formData }) => {
                        console.log('onSubmit event', selectedPaymentMethod, formData);
                        // Validar que payment_method_id esté presente
                        if (!formData.payment_method_id) {
                            alert('Por favor, selecciona un método de pago antes de continuar.');
                            return Promise.reject('Método de pago no seleccionado');
                        }

                        // Asegúrate que formData tenga el monto. El Brick debería proveerlo si preferenceId se usa.
                        if (!formData.transaction_amount) {
                            formData.transaction_amount = transactionAmount;
                        }
                        
                        // Asegúrate que formData tenga la descripción.
                        if (!formData.description) {
                            formData.description = "Inscripción Competidor - " + claseBarco;
                        }
                        // Asegúrate que formData tenga la referencia externa.
                        if (!formData.external_reference) {
                            formData.external_reference = `METRO_${claseBarco || 'no_barco'}`;
                        }
                        // Asegúrate que formData tenga el email del pagador. Es crucial en producción.
                        if (!formData.payer || !formData.payer.email) {
                            formData.payer = formData.payer || {};
                            // En producción, aquí deberías tener el email real del usuario.
                            // Si no lo recolectaste antes, es un buen momento para pedirlo o usar un default robusto.
                            formData.payer.email = formData.payer.email || "email_cliente_real@ejemplo.com"; 
                        }

                        // Envía la clase de barco a tu backend si la necesitas para el registro.
                        formData.clase_barco = claseBarco; 

                        return new Promise((resolve, reject) => {
                            fetch("/process_payment_with_brick", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify(formData),
                            })
                            .then((response) => response.json())
                            .then((data) => {
                                if (data.status === 'approved' || data.status === 'pending') {
                                    // Redirecciona a tus páginas de éxito/pendiente
                                    window.location.href = `/payment_success?payment_id=${data.payment_id}&status=${data.status}&collection_id=${data.payment_id}&clase_barco=${claseBarco}`;
                                    resolve();
                                } else {
                                    // Redirecciona a tu página de fallo
                                    window.location.href = `/payment_failure?payment_id=${data.payment_id || 'N/A'}&status=${data.status || 'rejected'}&clase_barco=${claseBarco}`;
                                    reject();
                                }
                            })
                            .catch((error) => {
                                console.error('Error al procesar el pago desde el backend:', error);
                                // En caso de error de red o del servidor, redirecciona a fallo.
                                window.location.href = `/payment_failure?clase_barco=${claseBarco}`;
                                reject();
                            });
                        });
                    },
                    onError: (error) => {
                        console.error('Error en Payment Brick:', error);
                        alert("Ocurrió un error al cargar las opciones de pago. Por favor, intenta de nuevo. Detalles: " + (error.message || JSON.stringify(error)));
                    },
                },
            },
        );
    </script>
    </body>
    </html>