<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }} - Campeonato Metropolitano</title>
    <!-- Incluir Tailwind CSS para un diseño rápido y moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluir SDK de MercadoPago.js V2 -->
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        /* Estilos personalizados para un look más pulido */
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-lg mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-slate-900">Finalizá tu Inscripción</h1>
            <p class="text-slate-600 mt-2">Completa el pago de forma segura a continuación.</p>
        </header>

        <main class="bg-white rounded-xl shadow-lg p-6 md:p-8">
            <!-- Resumen del pedido -->
            <div class="border-b border-slate-200 pb-4 mb-6">
                <h2 class="text-lg font-semibold text-slate-800">Resumen de tu compra</h2>
                <div class="flex justify-between items-center mt-4">
                    <span class="text-slate-600">{{ item_title }}</span>
                    <span class="font-bold text-slate-900 text-lg">${{ "%.2f"|format(total_price) }} ARS</span>
                </div>
            </div>

            <!-- Contenedor donde se renderizará el Payment Brick -->
            <div id="paymentBrick_container"></div>
            <div id="loader" class="text-center py-4 hidden">
                <p>Procesando tu pago, por favor espera...</p>
                 <!-- Simple spinner -->
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mt-4"></div>
            </div>

        </main>
        
        <footer class="text-center mt-6">
            <p class="text-sm text-slate-500">Pago procesado de forma segura por Mercado Pago.</p>
        </footer>
    </div>

    <script>
        // --- INICIALIZACIÓN DEL BRICK DE PAGO ---
        const mp = new MercadoPago('{{ public_key }}');
        const bricksBuilder = mp.bricks();

        // Función para renderizar el brick
        const renderPaymentBrick = async (builder) => {
            const settings = {
                // 1. Inicialización: 'amount' y 'preferenceId' son requeridos
                initialization: {
                    amount: {{ total_price }},
                    preferenceId: '{{ preference_id }}',
                },
                // 2. Customización: Ajusta la apariencia y el comportamiento
                customization: {
                    visual: {
                        style: {
                            theme: 'flat', // Otras opciones: 'default', 'bootstrap', 'dark'
                            headerColor: '#0f172a', // Color de cabecera (slate-900)
                            elementsColor: '#007bff', // Color de botones y elementos activos
                        }
                    },
                    paymentMethods: {
                        // Puedes configurar qué métodos de pago mostrar
                        // Por defecto, muestra los permitidos en la preferencia
                        maxInstallments: 1, // Limita a 1 cuota
                    }
                },
                // 3. Callbacks: Funciones que se ejecutan en diferentes momentos
                callbacks: {
                    onReady: () => {
                        /* * Callback que se ejecuta cuando el Brick está listo.
                         * Aquí puedes, por ejemplo, ocultar un loader.
                         */
                        console.log('Payment Brick está listo.');
                    },
                    onSubmit: ({ selectedPaymentMethod, formData }) => {
                        /*
                         * Callback que se ejecuta cuando el usuario hace clic en el botón de pagar.
                         * El Brick se encarga de todo el proceso de creación y confirmación del pago.
                         * No necesitas enviar los datos a tu backend aquí.
                         * El usuario será redirigido a las 'back_urls' que definiste en la preferencia.
                         * Devolvemos una Promise para que el Brick sepa que debe continuar con el envío.
                         */
                        console.log('Formulario enviado. El Brick se encargará del resto.');
                        document.getElementById('paymentBrick_container').classList.add('hidden');
                        document.getElementById('loader').classList.remove('hidden');

                        return new Promise((resolve, reject) => {
                            // Dejamos que el brick maneje la subida de datos a Mercado Pago.
                            resolve(); 
                        });
                    },
                    onError: (error) => {
                        /* * Callback para todos los errores que pueden ocurrir.
                         * Es un buen lugar para registrar los errores para debuggeo.
                         */
                        console.error('Error en Payment Brick:', error);
                        alert('Ocurrió un error. Por favor, revisa los datos ingresados.');
                        // Podrías mostrar un mensaje de error más amigable en la UI
                    },
                },
            };
            // 'payment' es el tipo de brick, 'paymentBrick_container' es el ID del div
            window.paymentBrick = await builder.create('payment', 'paymentBrick_container', settings);
        };

        // Renderizar el brick cuando la página carga
        renderPaymentBrick(bricksBuilder);
    </script>
</body>
</html>
