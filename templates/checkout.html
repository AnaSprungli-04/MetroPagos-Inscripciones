<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-g">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Completar Pago</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f4f4f4; margin: 0; }
        .container { max-width: 450px; width: 100%; padding: 2rem; background: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        p { color: #555; text-align: center; font-size: 1.1rem; }
        #status-screen { display: none; text-align: center; padding: 2rem; }
        #status-screen h2 { font-size: 1.5rem; }
        #loader { border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div id="payment-screen">
            <h1>Finalizar Inscripción</h1>
            <p><strong>Item:</strong> {{ item_title }}</p>
            <p><strong>Monto:</strong> ${{ "{:,.2f}".format(amount).replace(",", "X").replace(".", ",").replace("X", ".") }} ARS</p>
            <hr>
            <div id="payment-brick_container"></div>
        </div>

        <div id="status-screen">
            <h2 id="status-message">Procesando tu pago...</h2>
            <p>Por favor, no cierres ni recargues esta página.</p>
            <div id="loader"></div>
        </div>
    </div>

    <script src="https://sdk.mercadopago.com/js/v2"></script>

    <script>
        // --- CONSTANTES DEL GOOGLE FORM (para la redirección final) ---
        const GOOGLE_FORMS_COMPETIDORES_ID = "1FAIpQLSeA0tbwyKZ-u8zra-W6hlJL8TCTQOayqCpKwya3sON0ubS0nA";
        const GOOGLE_FORMS_ENTRY_ID_NUM_OPERACION = "entry.1161481877";
        const GOOGLE_FORMS_ENTRY_ID_CLASE_BARCO = "entry.1553765108";

        // --- INICIALIZACIÓN DEL BRICK ---
        const mp = new MercadoPago('{{ public_key }}');
        const bricksBuilder = mp.bricks();

        // Función que se ejecuta cuando el usuario envía el formulario
        const renderPaymentBrick = async (bricksBuilder) => {
            const settings = {
                initialization: {
                    amount: {{ amount }}, // Monto a pagar
                    payer: {
                        // Opcional: puedes pre-cargar datos del pagador si los tienes
                        // email: 'test_user_123@test.com',
                    },
                },
                customization: {
                    visual: {
                        style: {
                            theme: 'default', // o 'dark', 'bootstrap', 'flat'
                        },
                    },
                    paymentMethods: {
                        // Excluimos pagos en efectivo (Rapipago, etc.)
                        ticket: "all", 
                        bankTransfer: "all",
                        atm: "all",
                        maxInstallments: 1 // Limitar a 1 cuota
                    },
                },
                callbacks: {
                    onReady: () => {
                        // Callback para cuando el Brick está listo
                        console.log('Payment Brick está listo.');
                    },
                    onError: (error) => {
                        // Callback para errores
                        console.error(error);
                        alert('Hubo un error al procesar el pago. Por favor, revisa los datos.');
                    },
                    onSubmit: (cardFormData) => {
                        // Muestra la pantalla de "Procesando..."
                        document.getElementById('payment-screen').style.display = 'none';
                        document.getElementById('status-screen').style.display = 'block';

                        // Retorna una Promesa, el Brick esperará a que se resuelva
                        return new Promise((resolve, reject) => {
                            fetch('/process_payment', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                // Enviamos los datos del formulario junto con nuestros datos adicionales
                                body: JSON.stringify({
                                    ...cardFormData,
                                    description: '{{ item_title }}',
                                    additional_data: {
                                        clase_barco: '{{ clase_barco }}'
                                    }
                                }),
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'approved') {
                                    // ¡PAGO APROBADO!
                                    document.getElementById('status-message').innerText = '¡Pago aprobado! Redirigiendo...';
                                    
                                    // Construimos la URL del Google Form
                                    const paymentId = data.id;
                                    const claseBarcoEncoded = encodeURIComponent('{{ clase_barco }}');
                                    const googleFormsUrl = `https://docs.google.com/forms/d/e/${GOOGLE_FORMS_COMPETIDORES_ID}/viewform?usp=pp_url&${GOOGLE_FORMS_ENTRY_ID_NUM_OPERACION}=${paymentId}&${GOOGLE_FORMS_ENTRY_ID_CLASE_BARCO}=${claseBarcoEncoded}`;
                                    
                                    // Redirigimos al usuario
                                    window.location.href = googleFormsUrl;
                                    
                                    resolve(); // Avisamos al Brick que terminamos
                                } else {
                                    // PAGO RECHAZADO O PENDIENTE
                                    console.error('Pago no aprobado:', data);
                                    alert(`El pago fue ${data.status}. Razón: ${data.status_detail}`);
                                    
                                    // Volvemos a mostrar el formulario de pago
                                    document.getElementById('payment-screen').style.display = 'block';
                                    document.getElementById('status-screen').style.display = 'none';
                                    reject(); // Avisamos al Brick que hubo un problema
                                }
                            })
                            .catch(error => {
                                console.error('Error en el fetch:', error);
                                alert('Hubo un error de comunicación. Intenta de nuevo.');
                                document.getElementById('payment-screen').style.display = 'block';
                                document.getElementById('status-screen').style.display = 'none';
                                reject(); // Avisamos al Brick que hubo un problema
                            });
                        });
                    },
                },
            };
            window.paymentBrick = await bricksBuilder.create('payment', 'payment-brick_container', settings);
        };

        renderPaymentBrick(bricksBuilder);
    </script>
</body>
</html>